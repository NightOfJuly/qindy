package com.qindy.service;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.uber.h3core.H3Core;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * @author qindongyun
 * @Description:
 * @date 2018/11/1
 */
public class GetH3cell {

    public static void main(String[] args) {
        List<String> msgList = new ArrayList<>();
        msgList.add("{\"id\":\"973345617\",\"redis_insert_time\":1541049582426,\"created\":1541049582,\"order_state\":\"501\",\"queue_id\":\"1386269\",\"order\":{\"order_id\":\"973345617\",\"order_number\":\"\",\"source\":\"0\",\"channel\":\"01003\",\"user_id\":\"0\",\"name\":\"张*妮女士\",\"phone\":\"18201431960\",\"contact_phone\":\"18201431960\",\"vipcard\":\"\",\"car_id\":\"0\",\"driver\":\"测Nexus5x\",\"driver_id\":\"BJ9106\",\"driver_phone\":\"15300073731\",\"imei\":\"353626073942646\",\"city_id\":\"1\",\"call_type\":\"0\",\"call_time\":\"1541049550\",\"order_date\":\"20181101\",\"booking_time\":\"1541050149\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"1541049567\",\"end_time\":\"1541049572\",\"distance\":\"0\",\"charge\":\"0\",\"location_start\":\"叶青大厦\",\"location_end\":\"叶青大厦\",\"income\":\"21.10\",\"price\":\"21.10\",\"cast\":\"0.00\",\"cost_type\":\"0\",\"description\":\"直呼APP\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"1\",\"created\":\"1541049550\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"11\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":\"0.00\",\"use_fee\":\"0\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0000000001003\",\"lat\":\"40.018486\",\"lng\":\"116.476082\",\"driver_app_version\":\"4.9.4.1\",\"customer_app_version\":\"9.4.0\",\"dispatch_distance\":0,\"udid\":\"ff4196d53dbaaa9\",\"mac\":\"12:34:56:78:9A:BC\",\"accept_pos\":{\"lat\":\"40.018485\",\"lng\":\"116.476082\",\"time\":\"\"},\"accept_time\":\"1541049552\",\"ready_time\":1541049612,\"arrive_pos\":{\"lat\":\"40.018485\",\"lng\":\"116.476082\",\"time\":1541049562},\"arrive_time\":\"1541049562\",\"drive_pos\":{\"lat\":\"40.018485\",\"lng\":\"116.476083\",\"time\":1541049567},\"drive_time\":\"1541049567\",\"finish_pos\":{\"lat\":\"40.018485\",\"lng\":\"116.476083\",\"time\":1541049572},\"finish_time\":\"1541049572\",\"bonus_fee\":0},\"booking_id\":\"2b9d5d43b0583c535d1bf0a7a26d92d6\",\"driver_numbers\":\"1\",\"ext\":\"0\",\"source_ip\":\"111.204.119.130\",\"fail_type\":\"\",\"token\":\"05e267316720196349a4dd044c17c778\",\"mq_id\":\"orderStatus_973345617_1541049582426\",\"mq_createtime\":\"2018-11-01 13:19:42.001\"}");
        msgList.add("{\"id\":\"973345617\",\"redis_insert_time\":1541049550990,\"created\":1541049550,\"order_state\":\"102\",\"queue_id\":\"1386269\",\"order\":{\"order_id\":\"973345617\",\"order_number\":\"\",\"source\":\"0\",\"channel\":\"01003\",\"user_id\":\"0\",\"name\":\"张*妮女士\",\"phone\":\"18201431960\",\"contact_phone\":\"18201431960\",\"vipcard\":\"\",\"car_id\":\"0\",\"driver\":\"BJ00000\",\"driver_id\":\"BJ00000\",\"driver_phone\":\"BJ00000\",\"imei\":\"BJ00000\",\"city_id\":\"1\",\"call_type\":\"0\",\"call_time\":\"1541049550\",\"order_date\":\"20181101\",\"booking_time\":\"1541050149\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"0\",\"end_time\":\"0\",\"distance\":\"\",\"charge\":\"0\",\"location_start\":\"叶青大厦\",\"location_end\":\"\",\"income\":\"0.00\",\"price\":\"0.00\",\"cast\":\"0.00\",\"cost_type\":\"0\",\"description\":\"直呼APP\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"0\",\"created\":\"1541049550\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"0\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":\"0.00\",\"use_fee\":\"1\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0000000001003\",\"lat\":\"40.018486\",\"lng\":\"116.476082\",\"driver_app_version\":\"\",\"customer_app_version\":\"9.4.0\"},\"booking_id\":\"2b9d5d43b0583c535d1bf0a7a26d92d6\",\"driver_numbers\":\"1\",\"ext\":\"\",\"source_ip\":\"36.110.34.146\",\"fail_type\":\"\",\"mq_id\":\"orderStatus_973345617_1541049550990\",\"mq_createtime\":\"2018-11-01 13:19:10.001\"}");
        msgList.add("{\"id\":\"973345614\",\"redis_insert_time\":1541045382130,\"created\":1541045382,\"order_state\":\"600\",\"queue_id\":\"1386266\",\"order\":{\"order_id\":\"973345614\",\"order_number\":\"1541045283928730\",\"source\":\"0\",\"channel\":\"01001\",\"user_id\":\"0\",\"name\":\"先生\",\"phone\":\"15910509394\",\"contact_phone\":\"15910509394\",\"vipcard\":\"15910509394\",\"car_id\":\"0\",\"driver\":\"吴帆\",\"driver_id\":\"BJ28390\",\"driver_phone\":\"15311976073\",\"imei\":\"867950045446513\",\"city_id\":\"1\",\"call_type\":\"0\",\"call_time\":\"1541045283\",\"order_date\":\"20181101\",\"booking_time\":\"1541045876\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"1541045337\",\"end_time\":\"1541045354\",\"distance\":\"0\",\"charge\":\"0\",\"location_start\":\"叶青大厦\",\"location_end\":\"叶青大厦\",\"income\":\"21.10\",\"price\":\"21.10\",\"cast\":\"0.00\",\"cost_type\":\"1\",\"description\":\"直呼APP\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"1\",\"created\":\"1541045283\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"6\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":null,\"use_fee\":\"0\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0000000001001\",\"lat\":\"40.018619\",\"lng\":\"116.476227\",\"driver_app_version\":\"5.0.0.0\",\"customer_app_version\":\"9.4.0\",\"dispatch_distance\":59,\"accept_pos\":{\"lat\":\"40.018272\",\"lng\":\"116.476759\",\"time\":\"\"},\"accept_time\":\"1541045285\",\"ready_time\":1541045345,\"arrive_pos\":{\"lat\":\"40.01875\",\"lng\":\"116.47629\",\"time\":1541045291},\"arrive_time\":\"1541045291\",\"drive_pos\":{\"lat\":\"40.01875\",\"lng\":\"116.47629\",\"time\":1541045337},\"drive_time\":\"1541045337\",\"finish_pos\":{\"lat\":\"40.018471\",\"lng\":\"116.476585\",\"time\":1541045354},\"finish_time\":\"1541045354\"},\"booking_id\":\"aa926131bf99aedcf3154250d479d10b\",\"driver_numbers\":\"1\",\"ext\":\"\",\"source_ip\":\"\",\"pay_detail\":{\"pay_status\":0,\"pay_channel\":1,\"total\":21.1,\"cash\":21.1,\"pay_time\":1541045381,\"toll\":0},\"fail_type\":\"\",\"mq_id\":\"orderStatus_973345614_1541045382130\",\"mq_createtime\":\"2018-11-01 12:09:42.001\"}");
        msgList.add("{\"id\":\"973345610\",\"redis_insert_time\":1541044938788,\"created\":1541044938,\"order_state\":\"501\",\"queue_id\":\"1386262\",\"order\":{\"order_id\":\"973345610\",\"order_number\":\"1541044551537251\",\"source\":\"0\",\"channel\":\"01001\",\"user_id\":\"0\",\"name\":\"先生\",\"phone\":\"15311878919\",\"contact_phone\":\"15311878919\",\"vipcard\":\"\",\"car_id\":\"0\",\"driver\":\"测试一三\",\"driver_id\":\"BJ9013\",\"driver_phone\":\"13311004167\",\"imei\":\"990010805644524\",\"city_id\":\"1\",\"call_type\":\"0\",\"call_time\":\"1541044551\",\"order_date\":\"20181101\",\"booking_time\":\"1541045150\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"1541044846\",\"end_time\":\"1541044854\",\"distance\":\"71\",\"charge\":\"0\",\"location_start\":\"叶青大厦\",\"location_end\":\"叶青大厦\",\"income\":\"323.80\",\"price\":\"1.90\",\"cast\":\"0.00\",\"cost_type\":\"2\",\"description\":\"直呼APP\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"1\",\"created\":\"1541044551\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"281\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":null,\"use_fee\":\"0\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0000000001001\",\"lat\":\"40.018429\",\"lng\":\"116.476096\",\"driver_app_version\":\"4.9.4.1\",\"customer_app_version\":\"9.4.0\",\"dispatch_distance\":156,\"udid\":\"ecaff06f8f736a2f\",\"mac\":\"12:34:56:78:9A:BC\",\"accept_pos\":{\"lat\":\"40.018387\",\"lng\":\"116.475928\",\"time\":\"\"},\"accept_time\":\"1541044553\",\"ready_time\":1541044613,\"arrive_pos\":{\"lat\":\"40.018493\",\"lng\":\"116.476097\",\"time\":1541044834},\"arrive_time\":\"1541044834\",\"drive_pos\":{\"lat\":\"40.018493\",\"lng\":\"116.476097\",\"time\":1541044846},\"drive_time\":\"1541044846\",\"finish_pos\":{\"lat\":\"40.018493\",\"lng\":\"116.476097\",\"time\":1541044854},\"finish_time\":\"1541044854\",\"bonus_fee\":\"0.00\"},\"booking_id\":\"450537ad6aefb31de1ed91752499228a\",\"driver_numbers\":\"1\",\"ext\":\"0\",\"source_ip\":\"111.204.119.130\",\"fail_type\":\"\",\"token\":\"19ba70146226012033acf02edd81997c\",\"mq_id\":\"orderStatus_973345610_1541044938788\",\"mq_createtime\":\"2018-11-01 12:02:18.001\"}");
        msgList.add("{\"id\":\"973345609\",\"redis_insert_time\":1541044710111,\"created\":1541044710,\"order_state\":\"506\",\"queue_id\":\"1386261\",\"order\":{\"order_id\":\"973345609\",\"order_number\":\"\",\"source\":\"0\",\"channel\":\"01007\",\"user_id\":\"0\",\"name\":\"女士\",\"phone\":\"13261892441\",\"contact_phone\":\"13261892441\",\"vipcard\":\"\",\"car_id\":\"0\",\"driver\":\"BJ00000\",\"driver_id\":\"BJ00000\",\"driver_phone\":\"BJ00000\",\"imei\":\"BJ00000\",\"city_id\":\"127\",\"call_type\":\"0\",\"call_time\":\"1541044440\",\"order_date\":\"20181101\",\"booking_time\":\"1541045640\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"0\",\"end_time\":\"0\",\"distance\":\"\",\"charge\":\"0\",\"location_start\":\"阳泉北站\",\"location_end\":\"\",\"income\":\"0.00\",\"price\":\"0.00\",\"cast\":\"0.00\",\"cost_type\":\"0\",\"description\":\"直呼APP\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"0\",\"created\":\"1541044440\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"0\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":\"0.00\",\"use_fee\":\"1\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0000001099999\",\"lat\":\"38.120161\",\"lng\":\"113.444384\",\"driver_app_version\":\"\",\"customer_app_version\":\"9.0.0\"},\"booking_id\":\"558e8c65def12203334b960d2251ab0d\",\"driver_numbers\":\"1\",\"ext\":\"\",\"source_ip\":\"\",\"fail_type\":8,\"mq_id\":\"orderStatus_973345609_1541044710111\",\"mq_createtime\":\"2018-11-01 11:58:30.001\"}");
        msgList.add("{\"id\":\"973345607\",\"redis_insert_time\":1541044228229,\"created\":1541044228,\"order_state\":\"304\",\"queue_id\":\"1386259\",\"order\":{\"order_id\":\"973345607\",\"order_number\":\"\",\"source\":\"1\",\"channel\":\"0\",\"user_id\":\"0\",\"name\":\"先生\",\"phone\":\"15910509394\",\"contact_phone\":\"15910509394\",\"vipcard\":\"\",\"car_id\":\"0\",\"driver\":\"吴帆\",\"driver_id\":\"BJ28390\",\"driver_phone\":\"15311976073\",\"imei\":\"867950045446513\",\"city_id\":\"1\",\"call_type\":\"0\",\"call_time\":\"1541043877\",\"order_date\":\"20181101\",\"booking_time\":\"1541044440\",\"reach_time\":\"0\",\"reach_distance\":\"0\",\"start_time\":\"1541043930\",\"end_time\":\"0\",\"distance\":\"\",\"charge\":\"0\",\"location_start\":\"望京科技园\",\"location_end\":\"\",\"income\":\"0.00\",\"price\":\"0.00\",\"cast\":\"0.00\",\"cost_type\":\"0\",\"description\":\"呼叫中心\",\"cancel_type\":null,\"cancel_desc\":\"\",\"status\":\"0\",\"created\":\"1541043877\",\"cancel_code\":\"\",\"wait_time\":\"0\",\"driver_ready_time\":\"47\",\"driver_ready_distance\":\"0.00\",\"driver_receive_time\":\"0\",\"fee\":\"0.00\",\"use_fee\":\"0\",\"cash_only\":\"0\",\"bad_weather_surcharge\":\"-1\",\"type\":\"0010000000000\",\"lat\":\"40.017892\",\"lng\":\"116.480338\",\"driver_app_version\":\"5.0.0.0\",\"customer_app_version\":\"9.4.0\",\"dispatch_distance\":305,\"accept_pos\":{\"lat\":\"40.018981\",\"lng\":\"116.476191\",\"time\":\"\"},\"accept_time\":\"1541043882\",\"ready_time\":1541044106,\"arrive_pos\":{\"lat\":\"40.018474\",\"lng\":\"116.476584\",\"time\":1541043928},\"arrive_time\":\"1541043928\",\"drive_pos\":{\"lat\":\"40.018474\",\"lng\":\"116.476584\",\"time\":1541043930},\"drive_time\":\"1541043930\",\"finish_pos\":{\"lat\":\"40.018066\",\"lng\":\"116.476399\",\"time\":1541044223},\"finish_time\":\"1541044223\"},\"booking_id\":\"70590184448662\",\"driver_numbers\":\"1\",\"ext\":\"\",\"source_ip\":\"111.204.119.130\",\"fail_type\":\"\",\"mq_id\":\"orderStatus_973345607_1541044228229\",\"mq_createtime\":\"2018-11-01 11:50:28.001\"}");

        for (String msg : msgList){
            System.out.println(analysis(msg));
        }
    }

    public static String analysis(String message){
        Map<String,String> msgMap = (Map<String, String>) JSON.parse(message);
        if(msgMap == null){
            System.out.println("kafka msgMap is null");
        }
        String orderStr = JSONObject.toJSONString(msgMap.get("order"));
        Map<String,String> orderMap = (Map<String, String>) JSON.parse(orderStr);
        if(orderMap == null){
            System.out.println("kafka orderMap is null");
        }
        try {
            H3Core core = H3Core.newInstance();
            Long index = core.geoToH3(Double.valueOf(orderMap.get("lat")),Double.valueOf(orderMap.get("lng")),6);
            String result = "orderId:"+orderMap.get("order_id")+" lat:"+orderMap.get("lat")+" lng:"+orderMap.get("lng")+
                    " cityId:"+orderMap.get("city_id")+" cell_id:"+index+" order_state:" + msgMap.get("order_state")+
                    " phone"+orderMap.get("phone");
            return result;
        } catch (IOException e) {
            e.printStackTrace();
        }
        return "";
    }
}
